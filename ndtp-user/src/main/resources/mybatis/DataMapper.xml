<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ndtp.persistence.DataMapper">

	<!-- Data 총 건수 -->
	<select id="getDataTotalCount" parameterType="dataInfo" resultType="long">
		/* getDataTotalCount */
		SELECT COUNT(data_id) 
		FROM data_info
		<trim prefix="WHERE" prefixOverrides="AND">
			<if test="dataGroupId != null and dataGroupId > 0">
			data_group_id = #{dataGroupId}
			</if>
			<if test="dataType != null and dataType != ''">
			AND data_type = #{dataType}
			</if>
			<if test="sharing != null and sharing != ''">
			AND sharing = #{sharing}
			</if>
			<if test="userId != null and userId != ''">
			AND user_id = #{userId}
			</if>
			<if test="status != null and status != ''">
			AND status = #{status}
			</if>
			<if test="searchWord != null and searchWord != '' and searchValue != null and searchValue != '' and searchOption == '0'.toString()">
			AND ${searchWord} = #{searchValue}
			</if>
			<if test="searchWord != null and searchWord != '' and searchValue != null and searchValue != '' and searchOption == '1'.toString()">
			AND ${searchWord} LIKE '%' || #{searchValue} || '%'
			</if>
			<if test="startDate != null and startDate != ''">
			<![CDATA[
			AND insert_date >= TO_TIMESTAMP(#{startDate}, 'YYYYMMDDHH24MISSUS')
			]]>
			</if>
			<if test="endDate != null and endDate != ''">
			<![CDATA[
			AND insert_date <= TO_TIMESTAMP(#{endDate}, 'YYYYMMDDHH24MISSUS')
			]]>
			</if>
		</trim>
	</select>
	
	<!-- 데이터 상태별 통계 정보 -->
	<select id="getDataTotalCountByStatus" parameterType="dataInfo" resultType="long">
		/* getDataTotalCountByStatus */
		SELECT COUNT(data_id) 
		FROM data_info
		WHERE status = #{status} 
			AND parent > 0
			<if test="userId != null and userId != ''">
			AND user_id = #{userId}
			</if>
	</select>
	
	<!-- Data 목록 -->
	<select id="getAllListData" parameterType="dataInfo" resultType="dataInfo">
		/* getAllListData */
		SELECT A.*, ST_X(A.location) AS longitude, ST_Y(A.location) AS latitude, B.data_group_name
		FROM data_info A, data_group B
		WHERE A.data_group_id = #{dataGroupId}
			AND A.data_group_id = B.data_group_id
			<if test="userId != null and userId != ''">
			AND user_id = #{userId}
			</if>
			<if test="status != null and status != ''">
			AND status = #{status}
			</if>
		ORDER BY A.insert_date DESC, A.data_id DESC
	</select>
	
	<!-- Data 목록 -->
	<select id="getListData" parameterType="dataInfo" resultType="dataInfo">
		/* getListData */
		SELECT X.*, ST_X(X.location) AS longitude, ST_Y(X.location) AS latitude,
			(SELECT data_group_name FROM data_group WHERE data_group_id = X.data_group_id) AS dataGroupName
		FROM (
			SELECT *
			FROM data_info
			<trim prefix="WHERE" prefixOverrides="AND">
				<if test="dataGroupId != null and dataGroupId > 0">
				data_group_id = #{dataGroupId}
				</if>
				<if test="dataType != null and dataType != ''">
				AND data_type = #{dataType}
				</if>
				<if test="sharing != null and sharing != ''">
				AND sharing = #{sharing}
				</if>
				<if test="userId != null and userId != ''">
				AND user_id = #{userId}
				</if>
				<if test="status != null and status != ''">
				AND status = #{status}
				</if>
				<if test="searchWord != null and searchWord != '' and searchValue != null and searchValue != '' and searchOption == '0'.toString()">
				AND ${searchWord} = #{searchValue}
				</if>
				<if test="searchWord != null and searchWord != '' and searchValue != null and searchValue != '' and searchOption == '1'.toString()">
				AND ${searchWord} LIKE '%' || #{searchValue} || '%'
				</if>
				<if test="startDate != null and startDate != ''">
				<![CDATA[
				AND insert_date >= TO_TIMESTAMP(#{startDate}, 'YYYYMMDDHH24MISSUS')
				]]>
				</if>
				<if test="endDate != null and endDate != ''">
				<![CDATA[
				AND insert_date <= TO_TIMESTAMP(#{endDate}, 'YYYYMMDDHH24MISSUS')
				]]>
				</if>
			</trim>
			<choose>
			<when test="orderWord != null and orderWord != '' and orderValue != null and orderValue != ''">
			ORDER BY ${orderWord} ${orderValue}
			</when>
			<otherwise>
			ORDER BY insert_date DESC, data_id DESC
			</otherwise>
			</choose>
			OFFSET #{offset} LIMIT #{limit}
		) X
	</select>
	
	<!-- 공유 유형별 데이터 통계 -->
	<select id="getDataTotalCountBySharing" parameterType="string" resultType="dataInfo">
		/* getDataTotalCountBySharing */
		SELECT DISTINCT sharing, COUNT(*) AS dataCount 
		FROM data_info
		<if test="userId != null and userId != ''">
		WHERE user_id = #{userId}
		</if>
		GROUP BY sharing
	</select>
	
	<!-- Data 정보 -->
	<select id="getData" parameterType="dataInfo" resultType="dataInfo">
		/* getData */
		SELECT A.*, ST_X(A.location) AS longitude, ST_Y(A.location) AS latitude, B.data_group_name
		FROM data_info A, data_group B
		WHERE data_id = #{dataId}
			AND A.data_group_id = B.data_group_id
			<if test="userId != null and userId != ''">
			AND A.user_id = #{userId}
			</if>
	</select>
	
	<!-- Data 정보 -->
	<select id="getDataByDataKey" parameterType="dataInfo" resultType="dataInfo">
		/* getDataByDataKey */
		SELECT *, ST_X(location) AS longitude, ST_Y(location) AS latitude
		FROM data_info
		WHERE data_group_id = #{dataGroupId} 
			AND data_key = #{dataKey}
			<if test="userId != null and userId != ''">
			AND user_id = #{userId}
			</if>
	</select>
	
	<!-- 최상위 root dataInfo 정보 취득 -->
	<select id="getRootDataByDataGroupId" parameterType="int" resultType="dataInfo">
		/* getRootDataByDataGroupId */
		SELECT *, ST_X(location) AS longitude, ST_Y(location) AS latitude
		FROM data_info
		WHERE data_group_id = #{dataGroupId} 
			AND parent = 0
			AND depth = 1
	</select>
	
	<!-- Data 아이디 중복 체크 -->
	<select id="getDuplicationKeyCount" parameterType="dataInfo" resultType="int">
		/* getDuplicationKeyCount */
		SELECT COUNT(data_key) AS count 
		FROM data_info 
		WHERE data_group_id = #{dataGroupId} 
			AND data_key = #{dataKey}
	</select>
	
	<!-- 표시 순서 -->
	<select id="getViewOrderByParent" parameterType="dataInfo" resultType="int">
		/* getViewOrderByParent */
		SELECT COALESCE(MAX(view_order), 0) + 1 
		FROM data_info
		WHERE parent = #{parent}
	</select>
	
	<!-- 한 프로젝트 내 Root Parent 개수를 체크 -->
	<select id="getRootParentCount" parameterType="dataInfo" resultType="int">
		/* getRootParentCount */
		SELECT COUNT(data_id) 
		FROM data_info 
		WHERE data_group_id = #{dataGroupId} 
			AND parent = 0 
			AND depth = 1
			AND data_id != #{dataId}
	</select>
	
	<!-- converterJob 정보를 이용하여 data 정보 취득 -->
	<select id="getDataByConverterJob" parameterType="dataInfo" resultType="dataInfo">
		/* getDataByConverterJob */
		SELECT * 
		FROM data_info 
		WHERE user_id = #{userId}
			AND converter_job_id = #{converterJobId}
	</select>
	
	<!-- Data Attribute 정보 -->
	<!-- <select id="getDataAttribute" parameterType="long" resultType="dataInfoAttribute">
		/* getDataAttribute */
		SELECT *
		FROM data_info_attribute
		WHERE data_id = #{dataId}
	</select> -->
	
	<!-- Data 등록 -->
	<insert id="insertData" parameterType="dataInfo">
		/* insertData */
		<selectKey keyProperty="dataId" resultType="long" order="BEFORE">
    		SELECT NEXTVAL('data_info_seq')
  		</selectKey>
		INSERT INTO data_info(
			data_id, data_group_id, converter_job_id, data_key, data_name, data_type, sharing, user_id, mapping_type,
			<if test="location != null">
			location,
			</if>
			altitude, heading, pitch, roll, children_ancestor, children_parent, children_depth, children_view_order,
			<if test="metainfo != null and metainfo != ''">
			metainfo,
			</if>
			description
		) VALUES (
			#{dataId}, #{dataGroupId}, #{converterJobId}, #{dataKey}, #{dataName}, #{dataType}, #{sharing}, #{userId}, #{mappingType},
			<if test="location != null">
			ST_GeomFromText(#{location}, 4326),
			</if>
			#{altitude}, #{heading}, #{pitch}, #{roll}, #{childrenAncestor}, #{childrenParent}, #{childrenDepth}, #{childrenViewOrder},
			<if test="metainfo != null and metainfo != ''">
			TO_JSON(#{metainfo}::json),
			</if>
			#{description}
		)
	</insert>
	
	<!-- Data 수정 -->	
	<update id="updateData" parameterType="dataInfo">
		/* updateData */
		UPDATE data_info
		SET 
			<if test="dataGroupId != null and dataGroupId > 0">
			data_group_id = #{dataGroupId},
			</if>
			<if test="converterJobId != null and converterJobId > 0">
			converter_job_id = #{converterJobId},
			</if>
			<if test="sharing != null and sharing != ''">
			sharing = #{sharing},
			</if>
			<if test="dataName != null and dataName != ''">
			data_name = #{dataName},
			</if>
			<if test="dataType != null and dataType != ''">
			data_type = #{dataType},
			</if>
			<if test="mappingType != null and mappingType != ''">
			mapping_type = #{mappingType},
			</if>
			<if test="location != null">
			location = ST_GeomFromText(#{location}, 4326),
			</if>
			<if test="altitude != null">
			altitude = #{altitude},
			</if>
			<if test="heading != null">
			heading = #{heading},
			</if>
			<if test="pitch != null">
			pitch = #{pitch},
			</if>
			<if test="roll != null">
			roll = #{roll},
			</if>
			<if test="status != null and status != ''">
			status = #{status},
			</if>
			<if test="attributeExist != null">
			attribute_exist = #{attributeExist},
			</if>
			<if test="objectAttributeExist != null">
			object_attribute_exist = #{objectAttributeExist},
			</if>
			<if test="metainfo != null and metainfo != ''">
			metainfo = TO_JSON(#{metainfo}::json),
			</if>
			<if test="description != null and description != ''">
			description = #{description},
			</if>
			update_date = now()
		WHERE data_id = #{dataId}
			<if test="userId != null and userId != ''">
			AND user_id = #{userId}
			</if>
	</update>
	
	<!-- Data 상태 수정 -->	
	<update id="updateDataStatus" parameterType="dataInfo">
		/* updateDataStatus */
		UPDATE data_info
		SET status = #{status},
			update_date = NOW()
		WHERE data_id = #{dataId}
			<if test="userId != null and userId != ''">
			AND user_id = #{userId}
			</if>
	</update>
	
	<!-- Data 삭제 -->
	<delete id="deleteData" parameterType="dataInfo">
		/* deleteData */
		DELETE 
		FROM data_info 
		WHERE data_id = #{dataId}
			<if test="userId != null and userId != ''">
			AND user_id = #{userId}
			</if>
	</delete>
	
	<!-- Data 에 속하는 모든 Object ID를 삭제 -->
	<delete id="deleteDataByDataGroupId" parameterType="dataGroup">
		/* deleteDataByProjectId */
		DELETE 
		FROM data_info 
		WHERE data_group_id = #{dataGroupId} 
			AND user_id = #{userId}
	</delete>
	
	<!-- converterJob 정보를 이용하여 data 정보 삭제 -->
	<delete id="deleteDataByConverterJob" parameterType="dataInfo">
		/* deleteDataByConverterJob */
		DELETE
		FROM data_info 
		WHERE user_id = #{userId}
			AND converter_job_id = #{converterJobId}
	</delete>
</mapper>